= Upgrading Couchbase Server
:page-aliases: install:upgrade-strategies

[abstract]
Because of Couchbase Server's distributed architecture, several options are available for upgrading your cluster to a newer version.
These options accommodate the needs of a wide array of deployment topologies, while also incurring little to no downtime.

Upgrading Couchbase Server regularly is crucial to your cluster's overall health.
Upgrades let you take advantage of the latest bug fixes, enhancements, and features, while also ensuring that your cluster is fully supported in accordance with the http://www.couchbase.com/support-policy[Couchbase Support Policy^].
Review the xref:release-notes:relnotes.adoc[release notes] for each release to understand if there are bugs that might affect your deployments, or if there are new features that you can take advantage of.

== How Upgrade Works

Upgrading a Couchbase cluster is accomplished by upgrading each of the cluster's constituent nodes to a new version of Couchbase Server.
Only once all of the nodes are running the new version will the cluster be considered fully upgraded.

[#upgrade-types]
=== Upgrade Types

There are two principal types of upgrade: _online_ and _offline_.

* _Online_: The cluster remains active and available while each node is upgraded.
Nodes running the previous version of Couchbase Server need to be swapped with nodes that are running the new version of Couchbase Server.
Swapping in additional net-new nodes helps reduce the number of rebalances, and thus requires the least amount of time for completing the upgrade.
However, online upgrades can be completed using only the nodes currently in the cluster.
+
When performing an online upgrade, it's important to know that nodes do not need to be upgraded _in-place_.
That is to say: Even if you remove a node from a cluster, then upgrade the Couchbase Server installation on that node, and then finally add that node back into the cluster, the cluster will still treat it like a brand new node, and will wipe any pre-existing Couchbase data and configuration from the node.
This is because when you safely remove a node from an active cluster, that node passes all of its data to other online nodes, at which point that data can be changed at any time by a cluster user.
By treating every node as a new node, the cluster keeps data consistent.
+
Online upgrades rely heavily on a key function within Couchbase Server: The ability for a cluster to run in _mixed mode_.
As nodes get added and removed throughout the upgrade, the cluster will, at times, be composed of varying numbers of nodes running the older version of Couchbase Server, and varying numbers of nodes running the newer version.
Up until the point at which all of the active nodes in the cluster are running the newer version of Couchbase Server, the the cluster is considered to be in mixed mode.
Certain considerations should be taken when the cluster is operating in mixed mode.

* _Offline_: The cluster is taken offline while nodes are upgraded individually.
For these upgrades to be performed safely, all application traffic to the entire cluster must be shut down.
+
Unlike with online upgrades, an offline upgrade requires that each node be upgraded _in place_.
This means that the existing Couchbase Server installation on each node needs to be upgraded to the new version, with the existing data preserved.
After the upgrade is complete, the nodes warm up and the cluster comes back online at full capacity.
At this point, application traffic can resume to the upgraded cluster.

A key principle to understand when it comes to upgrading Couchbase Server is that a node cannot be active while it is being upgraded.
Therefore, the goal during upgrade should be one of two things: To keep the cluster _online_ by only upgrading nodes after they have safely passed on their responsibilities to other nodes in the cluster; or, to take the cluster _offline_, and upgrade all of the nodes individually, without the need to transfer anything between nodes.

An online upgrade strategy is recommended in the vast majority of deployment scenarios.
However, there may be cases, such as when a cluster is unstable, where an offline upgrade or other special type of upgrade might be recommended.
Since it's ultimately up to you to determine the best upgrade strategy for your particular deployment, you should review all of the sections on this page to help better understand your options.

If at any point you need help planning or performing an upgrade, please feel free to engage with Couchbase Support.

== Online Upgrade

Online upgrade, also known as a _rolling online upgrade_, is the preferred upgrade type, and should be used for most deployments unless special circumstances rule it out.
This is because online upgrades don't require any downtime, and can be performed using the safest and most straightforward methods. 

There are several options available for achieving a fully-online upgrade, each with their own advantages.
Some options provide a faster upgrade, but come with less data redundancy.
Other options provide both better speed and better redundancy, but come at a higher resource cost.
You should pick the option that best suits the needs of your deployment and budget.

[#online-upgrade-swap-rebalance]
=== Swap-Rebalance Option

This option provides the safest and most straightforward upgrade experience.
It involves adding n number of nodes to the cluster, and at the same time, removing an equal number of existing nodes.
If at the time of rebalance, n number of new nodes are marked for addition, and n nodes are marked for removal, the cluster will perform a _swap rebalance_.

During a swap rebalance of Data Service nodes, vBuckets are copied efficiently between the nodes that are being removed and the nodes that are being added.
This means that as soon as a vBucket is completely copied and synced on the new node, the Cluster Manager will seamlessly activate that vBucket on the new node, and deactivate it on the old node.
For other Couchbase services, replica data is merely redistributed, not copied.
This means that for services like Index and Search, the indexes are rebuilt on the active nodes.

==== Determining Which Nodes to Swap

To perform a swap-rebalance, you need a minimum of one spare node.
The spare node can be a net-new node that you've prepared solely for the purposes of upgrade, or it can be an existing node that you've removed from the cluster, upgraded, and are adding back into the cluster.




==== General Swap Rebalance Upgrade Strategy
--
. Configure as many new nodes as your budget and environment allow.
+
While a swap rebalance upgrade can be achieved with as little as one new node, swapping in more nodes at once will reduce the number of rebalances required.

. Each new node should mirror the node that it is replacing.
+
Hardware resources should be the same or greater, so that the new node can handle the workload of the node that it is replacing.
The new node should also be configured to be within the same topology.
For example, it should reside in the same availability/failure zone.

. New nodes need to have the desired new version of Couchbase Server installed on them, and the Couchbase service needs to be running.
+
This is also a good time to make platform updates to your deployment.
If every new node that you swap in is running the latest versions of your desired platform software (operating system, drivers, etc.), then by the time the entire cluster upgrade is complete, you'll have upgraded your entire platform as well.

. Add each new node to the cluster with the same Couchbase configuration settings as the node that it is replacing (e.g. services, server groups, etc.).
At the same time, mark for removal each node that is being replaced by the new nodes.

. When you start the rebalance, data will be transferred and activated on the new nodes.
Once all of the data is transferred to the new nodes, the old nodes are removed from the cluster.

. The removed nodes can be upgraded and added back to the cluster as new nodes for the purposes of continuing the rolling upgrade.
+
NOTE: It's important to remember that when adding new nodes to a cluster, any pre-existing Couchbase data is deleted from the node.
This is desired behavior during online upgrades, because the data has already been distributed and activated on the cluster.
This is different from offline upgrades, where no new nodes are added to the cluster, and all data and configuration information remains on the same nodes throughout the upgrade process.

. If there are nodes remaining in the cluster that are still running the previous version of Couchbase Server, then the cluster is considered to be running in _mixed mode_.
If there are no remaining active nodes running the previous version of Couchbase Server, then the upgrade is considered complete.
+
The upgraded cluster should have the same configuration and topology that it had before the upgrade began, except that now it is running a newer version of Couchbase Server.
--

==== Key Takeaways
* Swap-rebalance is the safest, most performant, and most straightforward option for a fully-online upgrade of Couchbase cluster.
Adding net-new nodes during the upgrade has the effect of adding excess capacity to the cluster, which means that you don't have to worry about increasing workload on other nodes.
* A rebalance is required each time nodes are swapped, which can increase the time it takes to upgrade.
However, you are allowed the flexibility to increase the number of new nodes added to the cluster, which in turn allows you to swap out more old nodes at once, reducing the number of rebalances required to complete the upgrade.
* As long as you swap an equal number of nodes (e.g. one for one, two for two, etc.), a swap rebalance will be triggered.
* New nodes should have the resources and capacity to handle the workload of the nodes that they are replacing. This keeps cluster capacity consistent, ensuring the fastest possible upgrade and the best possible performance.

=== Remove-Rebalance Option

This option is meant to be used when an upgrade must be completed using only the nodes that are currently in the cluster.
It involves removing a node from the cluster, upgrading that node to a new version of Couchbase Server, and then adding it back into the cluster as a new node.
When the node is removed from the cluster, its data and workload is seamlessly passed on to the other active nodes in the cluster.

The remove-rebalance option is similar to the <<online-upgrade-swap-rebalance,swap-rebalance>> option in that both options involve removing nodes from the cluster while simultaneously transferring their data and workload to other active nodes.
In the swap-rebalance scenario, resource constraints aren't really a factor since new cluster capacity is introduced at the beginning of the upgrade.
However, in a remove-rebalance scenario, no new capacity is added to the cluster.
This means that when a node is removed, the cluster will operate at reduced capacity until the node is upgraded and added back into the cluster.
Note that this doesn't necessarily mean that 

Because remove-rebalance upgrades reduce cluster capacity, you need to make sure that there is enough spare capacity across all necessary resources (disk, CPU, RAM, etc.) during the upgrade process.

This is in contrast with the <<online-upgrade-swap-rebalance,swap-rebalance>> option, where the workload is transferred to 

It is a good alternative to the <<online-upgrade-swap-rebalance,swap rebalance>> option, because it maintains similar high availability throughout the upgrade process.

This method is suitable when you must complete the upgrade using only the nodes currently in the cluster but want to maintain High Availability during the upgrade process.
Since this will reduce the capacity of the cluster, it is important to ensure that there is enough spare capacity across all necessary resources (disk, CPU, RAM, etc) during the upgrade process.
This process involves removing one running node from the cluster and rebalancing.
That node can then be upgraded and used in the Swap Rebalance upgrade procedure above.
When the last node has been upgraded, it can be rebalanced back into the cluster to return to full capacity.
+
Like a swap rebalance upgrade, this style will require multiple rebalances to complete.

[[graceful]]Graceful Failover and Delta Recovery::
This option involves performing a rolling online upgrade using
xref:manage:manage-nodes/failover-graceful.adoc[Graceful Failover] followed by
use of the procedure explained in
xref:manage:manage-nodes/recover-nodes.adoc[Recover a Node and Rebalance],
instead of the full addition and removal of nodes in a Swap Rebalance.
It is typically faster and less resource intensive because data does not need to be completely moved between nodes, rather the replicas are synchronized and activated during the failover and the data resynchronized when the node returns following the upgrade.
Another advantage compared to the other online upgrades is that this method preserves the global secondary indexes and doesn’t need to rebuild them.
+
The primary downside to this option is decreased high availability as replicas are used for faster failover and not recreated until the node is returned.
This option is not available when choosing to upgrade with net-new systems (as in the case of many cloud deployments) since those new nodes would not have the previous nodes’ data in place.
Use Option #1 when upgrading with net-new systems.

[#upgrade-paths]
== Supported Upgrade Paths

Couchbase Server supports direct upgrades up to a maximum of one _major_ version ahead.
You can skip _minor_ and _maintenance_ versions (X.*_Y_*.*_Z_*), but you cannot skip a major version.
That means, if you're more than one major version behind, you'll need to upgrade to an intermediate major version before arriving at the desired version. 

When upgrading to a new major version, it's highly recommended that you upgrade to the latest release of that major version.
This is made easier by the fact that each release of Couchbase Server contains the full software (even maintenance releases).
So, for example, if a cluster is running version 4.x, it can be upgraded directly to version 5.5.5 with a single package.

.Couchbase Server Enterprise Edition Upgrade Paths
[#table-upgrade-enterprise]
|===
| Current Version | Edition | Upgrade Option | Path

| 3.x
| Enterprise Edition
| Offline or Online
| 3.x -> 4.x -> 5.x -> 6.x

| 4.x
| Enterprise Edition
| Offline or Online
| 4.x -> 5.x -> 6.x

| 5.x
| Enterprise Edition
| Offline or Online
| Direct upgrade to 6.x
|===

.Couchbase Server Community Edition Upgrade Paths
[#table-upgrade-community]
|===
| Current Version | Edition | Upgrade Option | Path

| 3.x
| Community Edition
| Offline or Online
| 3.x -> 4.x -> 5.x -> 6.0

| 4.x
| Community Edition
| Offline or Online
| 4.x -> 5.x -> 6.0

| 5.x
| Community Edition
| Offline or Online
| Direct upgrade to 6.0
|===

Be aware of the currently-supported versions of Couchbase Server, as well as the versions that are at or near their end of life.
This information can be found in the http://www.couchbase.com/support-policy[Couchbase Support Policy^].

[#rollback-downgrade]
=== Rollbacks and Downgrades

Once you begin upgrading a Couchbase cluster, you can still roll back to the previous version, as long as at least one node is still on the previous version.
For example, if you have a four-node cluster with three nodes upgraded to 6.0, and one node still on 5.5, you can still roll all nodes back to 5.5.

Once all nodes in a cluster have been fully upgraded, the rollback window is closed.
If after you fully upgrade a cluster, you decide that you need to downgrade to the previous version, your only option is to set up a new Couchbase cluster running the older version, and then doing one of the following:

* Use xref:learn:clusters-and-availability/xdcr-overview.adoc[XDCR] to replicate data to the new cluster, and then migrate all client connections to new cluster.
* Restore data to the new cluster from a xref:backup-restore/backup-restore.adoc[backup].

[#upgrade-community-enterprise]
=== Upgrading from Community to Enterprise

If you're currently operating a Couchbase Server cluster on Community Edition, you can upgrade it to Enterprise Edition by way of a xref:upgrade-strategies.adoc#online-upgrade[rolling online upgrade].
This involves switching out the Community Edition nodes with fresh, net-new Enterprise Edition nodes.
Both 'swap rebalance' and 'remove and reblance' methods are supported.
(Delta Recovery is not supported since the new nodes must be fresh Enterprise Edition installations without any pre-existing Community Edition data remaining on them.)

The Enterprise Edition nodes must be running the same version number of Couchbase Server as the Community Edition nodes that they are replacing, otherwise the upgrade may fail.
This means you can't upgrade to a newer version of Couchbase Server while also upgrading to Enterprise Edition during the same rolling upgrade.

If you want to upgrade from an older version of _Community Edition_ to a newer version of _Enterprise Edition_, you need to perform two separate upgrade procedures:

. Upgrade the entire cluster to Enterprise Edition via a rolling online upgrade
. Upgrade to the desired version number of Couchbase Server using any supported type of upgrade

For example, if you wanted to upgrade from Couchbase Server 5.0.1 Community Edition to Couchbase Server 6.0.1 Enterprise Edition, the process would look like the following:

.Example Upgrade Path from Community to Enterprise
image::upgrade-ce-to-ee.png[,720]

////
/ This is an experimental ascii version of the upgrade path diagram
[ditaa]
....
              /-----------------\           /-----------------\
              |     Step 1:     |           |     Step 2:     |
              : Upgrade Edition |           : Upgrade Version |
              \--------+--------/           \--------+--------/
                       |                             |
                       |                             |
+-----------------+    :     +-----------------+     :      +-----------------+
|cBLU             | ---+---> |cRED             | ----+----> |cRED             |
|Cluster 1        | Rolling  |Cluster 1        |    Any     |Cluster 1        |
|Version: 5.0.1   | Online   |Version: 5.0.1   | Supported  |Version: 6.0.1   |
|Edition: CE      | Upgrade  |Edition: EE      |  Upgrade   |Edition: EE      |
|              {s}|          |              {s}|   Type     |              {s}|
+-----------------+          +-----------------+            +-----------------+
....
////

.Additional Notes about Upgrading from Community to Enterprise
* Couchbase Server clusters must be run either entirely on Enterprise Edition nodes, or entirely on Community Edition nodes.
** Once you've upgraded one node to Enterprise Edition, you must upgrade all of the other nodes before the cluster is considered as being in a steady, supportable state.
* If a rolling online upgrade to Enterprise Edition isn't possible in your environment, contact Couchbase for assistance.

[IMPORTANT]
====
Remember that Enterprise Edition is not free to run in production.
If you're interested in upgrading to Couchbase Server Enterprise Edition, check out the https://www.couchbase.com/products/editions[editions page^].
====

== Upgrade Options

Couchbase Server can be upgraded in multiple ways, each with their own pros and cons.
Which option is best for your cluster will depend on your deployment architecture, as well as the performance and availability needs of your applications.

[#online-upgrade]
=== Option #1 - Rolling Online Upgrade

A _rolling online upgrade_ is the preferred upgrade option for a Couchbase cluster and should be chosen unless you have special circumstances that would rule it out.
This method avoids downtime for the database and applications because all operations continue normally and high availability can be maintained.
Rolling upgrades use Couchbase's rebalance capability to redistribute the data amongst the nodes of a cluster, keeping it available for the duration of the upgrade.
Prior to version 5.0, special care should be taken when upgrading nodes running the index service.

Couchbase Server is specifically designed to provide fully online upgrades.
If you find this is not the case, please open a support ticket or report a bug.

There are three options for rolling online upgrades:

Swap Rebalance::
This method entails introducing new nodes into a Couchbase Server cluster as you remove an equal number of nodes to be upgraded.
It uses a feature called Swap Rebalance to move data efficiently from the existing nodes to the new nodes, without involving other nodes in the cluster.
+
As long as you swap an equal number of nodes (e.g.
one for one, two for two, etc.), a Swap Rebalance will be triggered.
This also keeps the cluster capacity consistent so as to not interfere with the load running on the cluster.
While this method is the safest and provides the most availability, it may require multiple rebalances and therefore be longer as compared to other upgrade options.
If the speed of an upgrade is a primary concern for your cluster,
see xref:manage:manage-nodes/failover-graceful.adoc[Graceful Failover] or
xref:upgrade-offline.adoc[Performing the Offline Upgrade].

Remove and Rebalance::
This method is suitable when you must complete the upgrade using only the nodes currently in the cluster but want to maintain High Availability during the upgrade process.
Since this will reduce the capacity of the cluster, it is important to ensure that there is enough spare capacity across all necessary resources (disk, CPU, RAM, etc) during the upgrade process.
This process involves removing one running node from the cluster and rebalancing.
That node can then be upgraded and used in the Swap Rebalance upgrade procedure above.
When the last node has been upgraded, it can be rebalanced back into the cluster to return to full capacity.
+
Like a swap rebalance upgrade, this style will require multiple rebalances to complete.

[[graceful]]Graceful Failover and Delta Recovery::
This option involves performing a rolling online upgrade using
xref:manage:manage-nodes/failover-graceful.adoc[Graceful Failover] followed by
use of the procedure explained in
xref:manage:manage-nodes/recover-nodes.adoc[Recover a Node and Rebalance],
instead of the full addition and removal of nodes in a Swap Rebalance.
It is typically faster and less resource intensive because data does not need to be completely moved between nodes, rather the replicas are synchronized and activated during the failover and the data resynchronized when the node returns following the upgrade.
Another advantage compared to the other online upgrades is that this method preserves the global secondary indexes and doesn’t need to rebuild them.
+
The primary downside to this option is decreased high availability as replicas are used for faster failover and not recreated until the node is returned.
This option is not available when choosing to upgrade with net-new systems (as in the case of many cloud deployments) since those new nodes would not have the previous nodes’ data in place.
Use Option #1 when upgrading with net-new systems.

[#intercluster]
== Option #2 - Upgrade Using XDCR

For this option, another Couchbase Server cluster is created (or already exists) and connected via Cross Datacenter Replication
(xref:learn:clusters-and-availability/xdcr-overview.adoc[Cross Data Center
Replication (XDCR)]).
The application is transitioned to use one cluster while the other(s) is/are upgraded.
While this upgrade process is relatively straightforward to set up, it requires more investment in servers/instances and networking, as well as a change to the application so that it can switch between clusters.
It is best used when an existing XDCR connection is already in place, the application needs a live rollback option or the original cluster cannot be upgraded online for some reason.

Keep in mind that XDCR is eventually consistent between clusters and so care should be taken when switching the application from one to the other.

For the fastest upgrade, the unused cluster(s) can be upgraded following the offline upgrade steps below (if not installed anew)

[#offline]
== Option #3 - Offline Upgrade

Choose an offline upgrade when the situation calls for an easy and fast upgrade method as well as when the database can incur a controlled outage.
The offline upgrade is more likely to succeed in situations where an online upgrade option might fail, but also the rare time a cluster is unstable and has been determined that a Couchbase Server upgrade will fix a specific issue.

This procedure involves upgrading one or more nodes without removing them from the cluster.
In some cases the whole cluster may be shut down, upgraded and restarted.

It is recommended to disable auto-failover before using this method and to re-enable it once complete.

== Choosing the Upgrade Strategy

Both the online and offline upgrade processes have trade-offs.
The following table illustrates some important aspects of the two upgrade strategies.

.Differences between upgrades
|===
| Feature | Online upgrade | XDCR upgrade | Offline upgrade

| Applications remain available
| Yes
| Yes
| No

| Cluster stays in operation
| Yes
| No
| No

| Cluster must be shut down
| No
| Yes
| Yes

| Typical steps
| Rebalance, upgrade, rebalance
| Switch to XDCR cluster, upgrade, switch back
| Upgrade one or more nodes without removing from cluster.
|===

IMPORTANT: Direct upgrade is not supported on macOS.
When upgrading on this platform, first back up your data and perform a clean uninstall of the old version.
Once you install the new version, restore the data back to the new cluster.

== Precautions for Couchbase Mobile’s Sync Gateway

Take special precaution when upgrading Couchbase Server if you use the cluster in conjunction with http://developer.couchbase.com/documentation/mobile/1.2/get-started/sync-gateway-overview/index.html[Sync Gateway^]

Sync Gateway versions prior to v1.2 do not support the automatic handling of Couchbase Server cluster topology changes for related buckets.
An upgrade of Couchbase used with older versions of Sync Gateway must carefully coordinate a manual reconfiguration of the Sync Gateway service connection between the key points in your upgrade process.

It is recommended first to upgrade all Couchbase Sync Gateways to at least version 1.2 before upgrading the Couchbase Server cluster to which they are connected.

== Upgrade FAQ

At which point in the upgrade process will the new features of the upgrade be available?::
Once every node in the cluster is upgraded to the target release, the new features of that release are available for use.
Even if 90% of all nodes are upgraded, the cluster is still considered to be on the older revision, and newer features are unavailable.

Do I have to upgrade the Couchbase client SDKs?::
You are not required to upgrade the client SDKs your applications use when you upgrade Couchbase Server.
Couchbase client SDKs are forward and backward compatible.
You may want to upgrade, however, because older client SDKs typically cannot take advantage of the newest Couchbase Server features.
+
It is strongly recommended to verify periodically the version of client SDK being used by applications and to plan for regular upgrades.
Every month Couchbase releases new versions that contain updates, bug fixes and new features for each SDK.
For more information and release notes, see the supported client SDKs.

Can I upgrade from Couchbase Community Edition to Enterprise Edition?::
Yes.
Refer to <<upgrade-community-enterprise,Upgrading from Community to Enterprise>> for detailed information.
+
If you'd like to know more about Couchbase Server Enterprise Edition, check out the https://www.couchbase.com/products/editions[editions page^].

Do I need to uninstall and reinstall, or just upgrade the Couchbase Server package?::
For all platforms except macOS, you only need to upgrade the package to the new version.
On macOS, Couchbase Server may not upgrade successfully without an uninstall and reinstall.
For instructions on how to uninstall Couchbase Server, see xref:install-uninstalling.adoc[Uninstalling Couchbase Server].
